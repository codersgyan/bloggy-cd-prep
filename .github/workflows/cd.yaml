name: Blogyy app CD

on:
    push:
        branches: [main]

jobs:
    build-image:
        runs-on: ubuntu-latest
        permissions:
            contents: write
        env:
            IMAGE_NAME: codersgyan/advance-ai-agent
            IMAGE_TAG: build-${{ github.sha }} # .run_number
        steps:
            - name: Checkout repository
              uses: actions/checkout@v3
              with:
                  persist-credentials: true
            - name: Update compose.yml
              uses: fjogeleit/yaml-update-action@v0.16.0
              with:
                  valueFile: compose.yaml
                  propertyPath: 'services["blog-server"].image'
                  value: ${{env.IMAGE_NAME}}:${{env.IMAGE_TAG}}
                  commitChange: false
            - name: Generate Githup App Token
              id: generate_token
              uses: tibdex/github-app-token@v1
              with:
                  app_id: ${{ secrets.APPLICATION_ID }}
                  private_key: ${{ secrets.APPLICATION_PRIVATE_KEY }}
            - name: Commit files
              run: |
                  git config --local user.email "test@test.com"
                  git config --local user.name "Test"
                  git commit -a -m "bump aAdd changes"
            - name: Push changes
              uses: ad-m/github-push-action@master
              with:
                  github_token: ${{ env.TOKEN }}
            - name: Log in to Docker Hub
              uses: docker/login-action@v1
              with:
                  username: ${{ secrets.DOCKERHUB_USERNAME }}
                  password: ${{ secrets.DOCKERHUB_PASSWORD }}
            - name: Sanity-check workspace
              run: |
                  echo "=== root files ==="
                  ls -1
                  echo "=== looking for your new text ==="
                  grep -R "Articles and posts" -n .
            - name: Build Docker image
              run: docker build -t ${{ env.IMAGE_NAME }}:${{ env.IMAGE_TAG }} -t ${{env.IMAGE_NAME}}:latest --no-cache --platform linux/amd64 .
            - name: Push Docker image to Docker Hub
              run: docker push ${{ env.IMAGE_NAME }}:${{ env.IMAGE_TAG }}

    deploy-swarm:
        name: Deploy the new version to docker deploy-swarm
        runs-on: ubuntu-latest
        env:
            IMAGE_NAME: codersgyan/advance-ai-agent
            IMAGE_TAG: build-${{ github.sha }} # .run_number
        needs:
            - build-image
        steps:
            - name: SSH and update service
              uses: appleboy/ssh-action@v1
              with:
                  host: ${{ secrets.SWARM_MANAGER_HOST }}
                  username: ${{ secrets.SWARM_USER }}
                  key: ${{ secrets.SWARM_SSH_KEY }}
                  port: ${{ secrets.SWARM_SSH_PORT }}
                  script: |
                      set -e

                      # 1. Go to your app directory (where compose.yaml lives)
                      cd ~/bloggy

                      # 2. Pull latest compose.yaml from Git
                      git fetch origin main
                      git checkout origin/main -- compose.yaml

                      docker pull ${{env.IMAGE_NAME}}:${{env.IMAGE_TAG}}

                      # 4. Deploy (or update) the stack
                      docker stack deploy -c compose.yaml bloggy_app
